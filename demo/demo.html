<!DOCTYPE html>
<html>
	<head>
		<style>
			h1 {
				background-color: blue;
				color: white;
			}

			.buttonClass {
				background-color: #04AA6D; /* green */
				color: white;
				border: none;
				border-radius: 12px;
				font-size: 16px;
				cursor: pointer;
			}
		</style>
	</head>
	<body>
		<center>
			<h1>Companies</h1>
			<ol id="companyList"></ol>
			<button class="buttonClass" onclick="addCompany()">Add company</button>
			<h1>Allocation results</h1>
			<button class="buttonClass" onclick="allocate()">Allocate</button>
			<div style="height:10px"></div>
			<textarea id="allocateResponse" style="width:800px;height:100px"></textarea>
		</center>
		<script>
			let lastCompanyIndex = 0
			let lastScenarioIndex = {}

			function toggle(companyIndex) {
				let toggleButtonElement = document.getElementById(`toggleButton${companyIndex}`)
				let addScenarioButtonElement = document.getElementById(`addScenarioButton${companyIndex}`)
				let companyScenariosElement = document.getElementById(`company${companyIndex}scenarios`)

				// determine whether company scenarios should be displayed
				let shouldDisplay = companyScenariosElement.hidden

				// update toggle button
				let toggleButtonBackgroundColor = "lightBlue"
				let toggleButtonText = "Show"

				if (shouldDisplay) {
					toggleButtonBackgroundColor = "#04AA6D" // green
					toggleButtonText = "Collapse"
				}

				toggleButtonElement.style.background = toggleButtonBackgroundColor
				toggleButtonElement.innerText = toggleButtonText

				// enable/disable add scenario button
				let addScenarioButtonBackgroundColor = "grey"
				let addScenarioButtonCursor = "text"

				if (shouldDisplay) {
					addScenarioButtonBackgroundColor = "#04AA6D" // green
					addScenarioButtonCursor = "pointer"
				}

				addScenarioButtonElement.style.background = addScenarioButtonBackgroundColor
				addScenarioButtonElement.style.cursor = addScenarioButtonCursor
				addScenarioButtonElement.disabled = !shouldDisplay

				// show/hide company scenarios
				companyScenariosElement.hidden = !shouldDisplay
			}

			function addCompany() {
				let html = `
					<li>
						<button id="toggleButton${lastCompanyIndex}" class="buttonClass" onclick="toggle(${lastCompanyIndex})" style="width:80px">Collapse</button>
						<label for="name${lastCompanyIndex}">Name</label>
						<textarea id="name${lastCompanyIndex}"></textarea>
						<label for="ticker${lastCompanyIndex}">Ticker</label>
						<textarea id="ticker${lastCompanyIndex}"></textarea>
						<label for="description${lastCompanyIndex}">Description</label>
						<textarea id="description${lastCompanyIndex}"></textarea>
						<label for="market_cap${lastCompanyIndex}">Market cap</label>
						<textarea id="market_cap${lastCompanyIndex}"></textarea>
						<button id="addScenarioButton${lastCompanyIndex}" class="buttonClass" onclick="addScenario(${lastCompanyIndex})">Add scenario</button>
						<ol id="company${lastCompanyIndex}scenarios"></ol>
					</li>
				`

				let htmlObject = document.createElement('div');
				htmlObject.innerHTML = html;
				document.getElementById("companyList").append(htmlObject);

				lastCompanyIndex += 1
			}

			function addScenario(companyIndex) {
				let scenarioIndex = 0

				if (lastScenarioIndex.hasOwnProperty(companyIndex)) {
					scenarioIndex = lastScenarioIndex[companyIndex]
				}

				let html = `
					<li>
						<label for="thesis${companyIndex}${scenarioIndex}">Thesis</label>
						<textarea id="thesis${companyIndex}${scenarioIndex}"></textarea>
						<label for="intrinsic_value${companyIndex}${scenarioIndex}">Intrinsic value</label>
						<textarea id="intrinsic_value${companyIndex}${scenarioIndex}"></textarea>
						<label for="probability${companyIndex}${scenarioIndex}">Probability</label>
						<textarea id="probability${companyIndex}${scenarioIndex}"></textarea>
					</li>
				`

				let htmlObject = document.createElement('div');
				htmlObject.innerHTML = html;
				document.getElementById(`company${companyIndex}scenarios`).append(htmlObject);

				scenarioIndex += 1
				lastScenarioIndex[companyIndex] = scenarioIndex
			}

			function allocate() {
				let companies = []

				for (let companyIndex = 0; companyIndex < lastCompanyIndex; companyIndex++) {
					let companyMap = {}

					for (let companyKey of ["name", "ticker", "description", "market_cap"]) {
						let value = document.getElementById(`${companyKey}${companyIndex}`).value

						if (companyKey == "market_cap") {
							value = +value
						}

						companyMap[companyKey] = value
					}

					let scenarios = []

					for (let scenarioIndex = 0; scenarioIndex < lastScenarioIndex[companyIndex]; scenarioIndex++) {
						let scenarioMap = {}

						for (let scenarioKey of ["thesis", "intrinsic_value", "probability"]) {
							let value = document.getElementById(`${scenarioKey}${companyIndex}${scenarioIndex}`).value

							if (scenarioKey != "thesis") {
								value = +value
							}

							scenarioMap[scenarioKey] = value
						}

						scenarios.push(scenarioMap)
					}

					companyMap["scenarios"] = scenarios
					companies.push(companyMap)
				}

				let inputJson = {}
				inputJson["companies"] = companies

				let internalEndpoint = 'http://localhost:8000/allocate'

				fetch(internalEndpoint, {
					method: 'POST',
					headers: {
						'dataType': 'json',
						'content-type': 'application/json'
					},
					body: JSON.stringify(inputJson)
				})
				.then(response => response.text())
				.then(data => document.getElementById('allocateResponse').value = JSON.stringify(JSON.parse(data), null, 4))
				.catch(error => console.error('Encountered error:', error))
			}
		</script>
	</body>
</html>
